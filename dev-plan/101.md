# 101 — Kid‑Friendly Testing & Acceptance Guide (Windows + Anaconda)

Hi! This guide shows **exactly** how to test and accept each phase of the IBKR ETF Rebalancer project. It’s written for a smart 12‑year‑old using **Windows** and **Anaconda**. Follow the steps in order. If something looks scary, don’t worry—just do it step by step.

---
## SHORTCUT
```bat
cd IB_Trade
conda create -n ibkr-rebal python=3.10 -y
conda activate ibkr-rebal
pip install -r requirements.txt -r requirements-dev.txt
```
## 0) One‑Time Setup (do this once)

### 0.1 Install Anaconda (if you don’t have it)
- Download and install **Anaconda** for Windows (just click “Next” until it finishes).

### 0.2 Make a project folder
- Put the unzipped **IB_Simple** folder somewhere easy, like `C:\Users\YourName\Documents\`.

### 0.3 Open **Anaconda Prompt**
- Press the Windows key, type **Anaconda Prompt**, and open it.

### 0.4 Create and activate your Python environment
```bat
conda create -n ibkr-rebal python=3.10 -y
conda activate ibkr-rebal
```
You should see `(ibkr-rebal)` at the beginning of the line now.

### 0.5 Go into the project
```bat
cd path\to\IB_Simple
```
Example:
```bat
cd C:\Users\YourName\Documents\IB_Simple
```

### 0.6 Install the tools
```bat
python -m pip install --upgrade pip
pip install -r requirements.txt -r requirements-dev.txt
pre-commit install
```
If you see warnings, that’s okay. If you see big red **ERROR** lines, tell an adult or check the Troubleshooting section at the bottom.

---

## How to Test & Accept a Phase
For each phase below, you’ll do three things:
1) **Run the exact commands** shown.  
2) **Check what happens** and compare with the “What success looks like” box.  
3) If it matches, **check the box** for that phase. ✅

> Tip: If a command says `path\to\...`, replace it with your real path.

---

## Milestone A — Foundations

### Phase A1 — Repo scaffold & local environment
**Goal:** The project opens, tools install, and a tiny test passes.

**Do this:**
```bat
conda activate ibkr-rebal
cd path\to\IB_Simple
pre-commit run --all-files
pytest -q -m "not integration"
```

> These commands match the **Daily Driver Commands** in `dev-plan/workflow.md`.

**What success looks like:**
- Pre‑commit finishes with no errors (maybe some files got auto‑fixed—that’s OK).
- `pytest` prints something like `1 passed`.

**Accept A1**: - [x] Passed

---

### Phase A2 — CI pipeline & quality gates
**Goal:** The project has a robot checker (CI) set up for GitHub.

**Do this:**
1) If you use GitHub, push the project (ask an adult if you’re new to Git).
2) On GitHub, open the repo → **Actions** tab. Make sure the **CI** workflow runs.

**What success looks like:**
- The CI job has a green checkmark. (Yellow means “running”; red means “failed”.)

**Accept A2**: - [x] Passed

---

## Milestone B — Inputs, Validation, & State

### Phase B1 — Config loader & checks
**Goal:** The app reads `config/settings.ini` and says if it’s OK.

**Do this (temporary placeholder test):**
```bat
python - <<"PY"
from src.io import config_loader
print("(placeholder) pretend we validated config")
PY
```

> When the real code exists, run:
> ```bat
> python -m src.io.validate_config config\settings.ini
> ```

**What success looks like:**
- For now, any output without a red error is fine.
- Later, a **good config** prints `OK`.
- If you edit the model weights so they **don’t add to 1**, the tool stops with a clear error.

**Accept B1**: - [x] Passed

---

### Phase B2 — CSV parser & portfolio checks
**Goal:** The app reads `data/portfolios.csv` and checks for mistakes.

**Do this (temporary placeholder test):**
```bat
python - <<"PY"
from pathlib import Path
p = Path("data/portfolios.csv")
print("CSV exists:", p.exists())
print("First 3 lines:")
print("\n".join(p.read_text().splitlines()[:3]))
PY
```

> When the real code exists, run:
> ```bat
> python -m src.io.validate_portfolios --config config\settings.ini data\portfolios.csv
> ```

**What success looks like:**
- File exists and prints the first lines.
- Later, a **good CSV** prints `OK`.
- If a column doesn’t add to **100%** or an **unknown symbol** appears, the tool stops with a clear error.

**Accept B2**:  - [x] Passed

---

### Phase B3 — IBKR connection & snapshot (paper)
**Goal:** The app connects to the paper IBKR account and shows your positions.

**Before you start:**
- Open **IBKR TWS** or **IB Gateway** and log in to **paper trading**.  
- In TWS Settings → **API**: Enable socket clients. Note the **port** (usually 4002).
- Edit `config/settings.ini` → put your **account_id** and correct **port**.

**Do this:**
```bat
python -m src.snapshot --config config\settings.ini
```

**What success looks like:**
- You’ll see a small JSON‑like list of **positions and cash in USD**.
- Any CAD cash in the account is **ignored**.
- This phase requires a **manual integration test**.

**Accept B3**:  - [x] Passed

---

## Milestone C — Core Logic & Preview

### Phase C1 — Model mixing & target builder
**Goal:** Mix the 3 models using their weights to make **final targets**.

**Do this (placeholder):**
```bat
python - <<"PY"
from src.core import targets
print("(placeholder) final targets would be shown here")
PY
```
> When the real code exists, you might run:
> ```bat
> python -m src.core.targets --config config\settings.ini --csv data\portfolios.csv
> ```
> Expect a table like: `SPY 25.0%`, `IAU 7.0%`, ... and totals ≈ 100%.

**What success looks like:**
- A table/list of target percentages that add up to about 100%.
- Missing symbols are treated as **0%**.
- If `CASH` is in the CSV, it shows up too.

**Accept C1**: - [x] Passed

---

### Phase C2 — Drift, triggers & prioritization
**Goal:** Compare what you **own now** vs **targets**; show **drift** in **%** and **$**.

**Do this :**
```bat
pytest tests/unit/test_drift.py::test_per_holding_mode_triggers_symbols_and_skips_small_drifts -q
pytest tests/unit/test_drift.py::test_total_drift_mode_selects_largest_until_band -q
pytest tests/unit/test_drift.py::test_prioritize_by_drift_filters_and_sorts -q
pytest tests/unit/test_prioritize.py::test_prioritize_filters_and_sorts_by_abs_drift_usd -q
python src/rebalance.py --dry-run --config config/settings.ini --csv data/portfolios.csv

```
These commands will:
1. Display drift % and $ for each symbol.
2. Demonstrate both trigger modes (per_holding and total_drift).
3. Show prioritization, skipping trades below min_order_usd and listing largest drifts first.
4. Verify the expected behavior via pytest tests.

**What success looks like:**
- Each row shows **drift %** and **drift $** for a symbol.
- Trades follow the configured rule (`per_holding` or `total_drift`).
- Trades smaller than `min_order_usd` are skipped.
- Biggest drifts appear first.

**Accept C2**: ☐ Passed

---

### Phase C3 — Sizing, leverage guard, rounding, cash buffer
**Goal:** Turn the drifts into **share quantities** we should buy/sell safely.

**Do this (placeholder):**
```bat
python - <<"PY"
from src.core import sizing
print("(placeholder) share sizes with leverage checks would be here")
PY
```
> Later, expect whole‑share numbers (unless fractional is allowed) and a note that leverage stays under the max.

**What success looks like:**
- You see numbers of shares to trade.
- A small **cash buffer** is kept aside.
- Leverage stays **below `max_leverage`**.
- If fractional shares aren’t allowed, numbers are rounded.
- Trades that become tiny after rounding are skipped.

**Accept C3**: ☐ Passed

---

### Phase C4 — Preview & CLI confirmation
**Goal:** Show a full **trade plan** and ask **“Proceed? [y/N]”**.

**Do this (works now as a placeholder):**
```bat
python src\rebalance.py --dry-run --config config\settings.ini --csv data\portfolios.csv
```

**What success looks like:**
- You see a “Preview would be generated here” message (placeholder).
- In the real version, the table shows **drift %** and **drift $** plus a batch summary.
- No orders go to IBKR in **dry run**.

**Accept C4**: ☐ Passed

---

## Milestone D — Execution & Reporting

### Phase D1 — Order submission (paper)
**Goal:** After you press **Y**, the app sends **market orders** (adaptive/midprice if possible; else plain market).

**Do this (placeholder today):**
```bat
python src\rebalance.py --confirm --config config\settings.ini --csv data\portfolios.csv
```
When it asks `Proceed? [y/N]:` type **y** and hit **Enter**.

**What success looks like:**
- Today: messages saying “Submitting batch...” and “Done” (placeholder).
- Real app: orders go to your **paper** account and finish.
- If the market is closed and `prefer_rth=true`, the app warns and stops.

**Accept D1**: ☐ Passed

---

### Phase D2 — Reporting & logging
**Goal:** Save a **CSV report** for each run in the `reports/` folder.

**Do this:**
- After running D1, look in the `reports/` folder.
- Or run:
  ```bat
  powershell -Command "Get-ChildItem reports | Sort-Object LastWriteTime -Descending | Select-Object -First 1"
  ```

**What success looks like:**
- Today: the placeholder prints say a report would be written.
- Real app: a **timestamped CSV** appears with columns like: symbol, target %, current %, drift %/$, action, qty, status, etc.

**Accept D2**: ☐ Passed

---

## Milestone E — Hardening & Release

### Phase E1 — Resilience & polish
**Goal:** Fewer weird crashes and nicer messages.

**Do this:**
- Try running commands when TWS is **closed** (should show a friendly message).  
- Try a broken CSV (should **abort** with a clear explanation).  
- Press **Ctrl+C** during a run (should stop cleanly).

**What success looks like:**
- The app explains what went wrong and how to fix it. No messy crashes.

**Accept E1**: ☐ Passed

---

### Phase E2 — Docs & handoff
**Goal:** Anyone can follow the docs and succeed.

**Do this:**
- Give the repo to a friend. Ask them to follow **README + this 101 guide**.  
- They should reach **dry‑run** and then a tiny **paper trade**.

**What success looks like:**
- Your friend succeeds without needing secret tips from you.

**Accept E2**: ☐ Passed

---

## Troubleshooting (friendly tips)
- **Command not found?** Make sure the **Anaconda Prompt** is open and the env is active: `conda activate ibkr-rebal`.
- **Permission error?** Close any programs using the files and try again.
- **TWS/Gateway connection fails?** Open TWS (paper) → Settings → API enabled; correct **port** (usually 4002). Update `config/settings.ini`.
- **Pip failed?** Run `python -m pip install --upgrade pip` and try `pip install -r requirements.txt -r requirements-dev.txt` again.
- **Weird Windows path?** Use quotes: `cd "C:\\Users\\YourName\\Documents\\IB_Simple"`.

---

## You did it!
Check off each **Accept** box as you go. When all boxes are checked, your MVP is ready. 🎉

---

### Notes for Maintainers
- Keep CLI names (`validate_config`, `validate_portfolios`, `snapshot`) in sync with the real modules.
- If the **Daily Driver Commands** change, update Phase A1 here too.

